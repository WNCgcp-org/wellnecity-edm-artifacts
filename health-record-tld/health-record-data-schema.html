<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HEALTH_RECORD TLD — Data Schema</title>
  <style>
    :root {
      --primary: #1a5276;
      --primary-light: #2980b9;
      --accent: #16a085;
      --bg: #f8f9fa;
      --card-bg: #ffffff;
      --text: #2c3e50;
      --text-light: #7f8c8d;
      --border: #dee2e6;
      --shadow: 0 2px 8px rgba(0,0,0,0.08);
      --sidebar-w: 280px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      padding: 1.5rem 2rem 1.5rem calc(var(--sidebar-w) + 2rem);
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 100;
    }
    header h1 { font-size: 1.5rem; font-weight: 600; }
    header p { color: rgba(255,255,255,0.85); font-size: 0.9rem; }
    .header-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-top: 0.7rem;
    }
    .view-toggle {
      display: flex;
      background: rgba(255,255,255,0.15);
      border-radius: 6px;
      overflow: hidden;
    }
    .view-toggle button {
      background: none;
      border: none;
      color: rgba(255,255,255,0.7);
      padding: 0.4rem 1rem;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    .view-toggle button.active {
      background: rgba(255,255,255,0.25);
      color: white;
    }
    .view-toggle button:hover { color: white; }
    .search-box {
      flex: 1;
      max-width: 350px;
    }
    .search-box input {
      width: 100%;
      padding: 0.4rem 0.8rem;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 6px;
      background: rgba(255,255,255,0.15);
      color: white;
      font-size: 0.85rem;
      outline: none;
    }
    .search-box input::placeholder { color: rgba(255,255,255,0.5); }
    .search-box input:focus { border-color: rgba(255,255,255,0.6); background: rgba(255,255,255,0.2); }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0; left: 0; bottom: 0;
      width: var(--sidebar-w);
      background: var(--card-bg);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      z-index: 101;
      box-shadow: 2px 0 8px rgba(0,0,0,0.05);
    }
    .sidebar-header {
      background: var(--primary);
      color: white;
      padding: 1.5rem 1.2rem;
      font-weight: 600;
      font-size: 1rem;
    }
    .sidebar-header small { display: block; font-weight: 400; opacity: 0.8; font-size: 0.8rem; margin-top: 0.2rem; }
    .sidebar nav { padding: 0.5rem 0; }
    .sidebar nav a {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.55rem 1.2rem;
      color: var(--text);
      text-decoration: none;
      font-size: 0.85rem;
      border-left: 3px solid transparent;
      transition: all 0.15s;
    }
    .sidebar nav a:hover { background: #f0f7ff; border-left-color: var(--primary-light); }
    .sidebar nav a.active { background: #eaf2f8; border-left-color: var(--primary); font-weight: 600; }
    .sidebar nav a .num {
      display: inline-block;
      width: 22px; height: 22px;
      background: var(--border);
      border-radius: 50%;
      text-align: center;
      line-height: 22px;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-light);
      flex-shrink: 0;
    }
    .sidebar nav a.active .num { background: var(--primary); color: white; }
    .sidebar nav a .field-count {
      margin-left: auto;
      font-size: 0.75rem;
      color: var(--text-light);
    }

    /* Main content */
    .content {
      margin-left: var(--sidebar-w);
      padding: 7rem 2rem 2rem 2rem;
    }
    .entity-section {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .entity-section.hidden { display: none; }
    .entity-header {
      background: var(--primary);
      color: white;
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .entity-header h2 { font-size: 1.1rem; font-weight: 600; }
    .entity-meta {
      display: flex;
      gap: 0.5rem;
      margin-left: auto;
      flex-wrap: wrap;
    }
    .tag {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .tag-openehr { background: #e8f8f5; color: #0e6655; }
    .tag-fhir { background: #fef3e2; color: #b7791f; }
    .tag-fields { background: rgba(255,255,255,0.2); color: white; }
    .entity-desc {
      padding: 0.8rem 1.5rem;
      background: #f7fbff;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
      color: var(--text-light);
    }
    .entity-body { padding: 0; }

    /* Table view */
    .table-view table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .table-view th {
      background: #eaf2f8;
      color: var(--primary);
      padding: 0.6rem 1rem;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    .table-view td { padding: 0.5rem 1rem; border-bottom: 1px solid #f0f0f0; }
    .table-view tr:hover td { background: #f7fbff; }
    .table-view .field-name { font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; font-weight: 500; color: var(--primary); font-size: 0.82rem; }
    .table-view .field-type { font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; color: var(--accent); font-size: 0.82rem; }
    .constraint {
      display: inline-block;
      padding: 0.1rem 0.35rem;
      border-radius: 3px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-right: 0.2rem;
    }
    .c-pk { background: #ffeaa7; color: #886800; }
    .c-fk { background: #dfe6e9; color: #555; }
    .c-r { background: #fab1a0; color: #7a2e00; }
    .c-i { background: #a29bfe; color: white; }
    .c-u { background: #81ecec; color: #006060; }

    /* JSON view */
    .json-view { display: none; padding: 1rem 1.5rem; }
    .json-view pre {
      background: #1e272e;
      color: #d2dae2;
      padding: 1.2rem;
      border-radius: 6px;
      font-size: 0.82rem;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      overflow-x: auto;
      line-height: 1.5;
    }
    .json-view .jk { color: #78e08f; }
    .json-view .js { color: #f8c291; }
    .json-view .jn { color: #82ccdd; }
    .json-view .jb { color: #e55039; }
    .json-view .jc { color: #636e72; font-style: italic; }

    .match-highlight { background: #fff3bf; border-radius: 2px; padding: 0 2px; }
    .no-results {
      text-align: center;
      padding: 3rem;
      color: var(--text-light);
      font-size: 1.1rem;
    }
    .no-results.hidden { display: none; }

    @media print {
      .sidebar { display: none; }
      header { position: static; padding-left: 2rem; }
      .content { margin-left: 0; padding-top: 1rem; }
      .entity-section { break-inside: avoid; }
    }
    @media (max-width: 768px) {
      .sidebar { display: none; }
      header { padding-left: 2rem; }
      .content { margin-left: 0; }
    }
  </style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header">
    HEALTH_RECORD TLD
    <small>12 Entities &bull; ~315 Fields</small>
  </div>
  <nav id="sidebar-nav"></nav>
</div>

<header>
  <h1>HEALTH_RECORD TLD — Data Schema</h1>
  <p>Wellnecity Enterprise Data Model &bull; openEHR + FHIR Hybrid Architecture</p>
  <div class="header-controls">
    <div class="view-toggle">
      <button class="active" onclick="setView('table')">Table View</button>
      <button onclick="setView('json')">JSON Schema</button>
    </div>
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search fields, types, entities..." oninput="filterEntities(this.value)">
    </div>
  </div>
</header>

<div class="content" id="content"></div>
<div class="no-results hidden" id="noResults">No entities or fields match your search.</div>

<script>
const ENTITIES = [
  {
    id: "health_record_composition",
    name: "HEALTH_RECORD_COMPOSITION",
    description: "Container that groups related clinical entries following the openEHR COMPOSITION pattern. Each composition represents a clinical document or collection of related observations.",
    openehr: "COMPOSITION",
    fhir: "Bundle / Composition",
    fields: [
      { name: "composition_id", type: "uuid", constraints: ["PK", "R"], desc: "Unique identifier" },
      { name: "member_id", type: "uuid", constraints: ["FK", "R", "I"], desc: "Reference to CORE.MEMBER" },
      { name: "employer_id", type: "uuid", constraints: ["FK", "R", "I"], desc: "Reference to CORE.EMPLOYER" },
      { name: "archetype_id", type: "string(255)", constraints: ["R"], desc: "openEHR archetype ID (e.g., openEHR-EHR-COMPOSITION.encounter.v1)" },
      { name: "template_id", type: "string(255)", constraints: [], desc: "Template ID if using operational template" },
      { name: "composition_type", type: "string(50)", constraints: ["R", "I"], desc: "Type: ENCOUNTER, DISCHARGE_SUMMARY, PROBLEM_LIST, MEDICATION_LIST, LAB_REPORT, VITAL_SIGNS" },
      { name: "category", type: "string(50)", constraints: ["R"], desc: "openEHR category: EVENT, PERSISTENT, EPISODIC" },
      { name: "context_start_time", type: "datetime", constraints: ["R"], desc: "Start time of clinical context" },
      { name: "context_end_time", type: "datetime", constraints: [], desc: "End time of context" },
      { name: "context_setting", type: "string(100)", constraints: [], desc: "Care setting code (home, primary_care, emergency, inpatient)" },
      { name: "context_location", type: "string(255)", constraints: [], desc: "Location of care" },
      { name: "composer_id", type: "string(100)", constraints: [], desc: "Author/composer identifier" },
      { name: "composer_name", type: "string(255)", constraints: [], desc: "Author name" },
      { name: "language", type: "string(10)", constraints: [], desc: "Language code (ISO 639-1)" },
      { name: "territory", type: "string(10)", constraints: [], desc: "Territory code (ISO 3166-1)" },
      { name: "version_number", type: "integer", constraints: ["R"], desc: "Version of this composition (starts at 1)" },
      { name: "is_current", type: "boolean", constraints: ["R"], desc: "True if this is the current version" },
      { name: "preceding_version_id", type: "uuid", constraints: ["FK"], desc: "Reference to previous version" },
      { name: "status", type: "string(30)", constraints: ["R"], desc: "ACTIVE, SUPERSEDED, DELETED" },
      { name: "fhir_bundle_id", type: "string(100)", constraints: ["I"], desc: "FHIR Bundle identifier for mapping" },
      { name: "source", type: "string(50)", constraints: [], desc: "Source system" },
      { name: "source_id", type: "string(100)", constraints: [], desc: "Source record ID" },
      { name: "created_at", type: "datetime", constraints: ["R"], desc: "Record creation timestamp" },
      { name: "updated_at", type: "datetime", constraints: ["R"], desc: "Last update timestamp" }
    ]
  },
  {
    id: "problem",
    name: "PROBLEM",
    description: "Diagnoses, health problems, and clinical conditions. Supports both active problem lists and historical diagnoses.",
    openehr: "EVALUATION.problem_diagnosis.v1",
    fhir: "Condition",
    fields: [
      { name: "problem_id", type: "uuid", constraints: ["PK", "R"], desc: "Unique identifier" },
      { name: "composition_id", type: "uuid", constraints: ["FK", "I"], desc: "Parent composition (optional)" },
      { name: "member_id", type: "uuid", constraints: ["FK", "R", "I"], desc: "Reference to CORE.MEMBER" },
      { name: "archetype_id", type: "string(255)", constraints: ["R"], desc: "openEHR archetype ID" },
      { name: "problem_name", type: "string(500)", constraints: ["R"], desc: "Problem/diagnosis name (text)" },
      { name: "problem_code", type: "string(20)", constraints: ["I"], desc: "ICD-10-CM or SNOMED CT code" },
      { name: "problem_code_system", type: "string(100)", constraints: [], desc: "Code system URI (http://hl7.org/fhir/sid/icd-10-cm)" },
      { name: "problem_code_display", type: "string(500)", constraints: [], desc: "Code display text" },
      { name: "clinical_status", type: "string(30)", constraints: ["R", "I"], desc: "active, recurrence, relapse, inactive, remission, resolved" },
      { name: "verification_status", type: "string(30)", constraints: [], desc: "unconfirmed, provisional, differential, confirmed, refuted, entered-in-error" },
      { name: "category", type: "string(50)", constraints: [], desc: "problem-list-item, encounter-diagnosis, health-concern" },
      { name: "severity", type: "string(30)", constraints: [], desc: "mild, moderate, severe" },
      { name: "body_site", type: "string(255)", constraints: [], desc: "Anatomical location" },
      { name: "body_site_code", type: "string(20)", constraints: [], desc: "SNOMED body site code" },
      { name: "onset_date", type: "date", constraints: [], desc: "Date of onset" },
      { name: "onset_age", type: "string(50)", constraints: [], desc: "Age at onset (e.g., '45 years')" },
      { name: "abatement_date", type: "date", constraints: [], desc: "Date resolved/inactive" },
      { name: "recorded_date", type: "datetime", constraints: ["R"], desc: "When recorded in system" },
      { name: "recorder_id", type: "string(100)", constraints: [], desc: "Who recorded (practitioner ID)" },
      { name: "asserter_id", type: "string(100)", constraints: [], desc: "Who asserted the condition" },
      { name: "encounter_id", type: "uuid", constraints: ["FK", "I"], desc: "Related encounter" },
      { name: "clinical_note", type: "string", constraints: [], desc: "Additional clinical notes" },
      { name: "fhir_condition_id", type: "string(100)", constraints: ["I"], desc: "FHIR Condition identifier" },
      { name: "source", type: "string(50)", constraints: [], desc: "Source system" },
      { name: "source_id", type: "string(100)", constraints: [], desc: "Source record ID" },
      { name: "created_at", type: "datetime", constraints: ["R"], desc: "Record creation timestamp" },
      { name: "updated_at", type: "datetime", constraints: ["R"], desc: "Last update timestamp" }
    ]
  },
  {
    id: "allergy",
    name: "ALLERGY",
    description: "Allergies, intolerances, and adverse reaction risks. Records clinical assessment of potential risk upon exposure to substances.",
    openehr: "EVALUATION.adverse_reaction_risk.v1",
    fhir: "AllergyIntolerance",
    fields: [
      { name: "allergy_id", type: "uuid", constraints: ["PK", "R"], desc: "Unique identifier" },
      { name: "composition_id", type: "uuid", constraints: ["FK", "I"], desc: "Parent composition (optional)" },
      { name: "member_id", type: "uuid", constraints: ["FK", "R", "I"], desc: "Reference to CORE.MEMBER" },
      { name: "archetype_id", type: "string(255)", constraints: ["R"], desc: "openEHR archetype ID" },
      { name: "substance_name", type: "string(255)", constraints: ["R"], desc: "Causative agent name" },
      { name: "substance_code", type: "string(50)", constraints: ["I"], desc: "RxNorm, SNOMED, or UNII code" },
      { name: "substance_code_system", type: "string(100)", constraints: [], desc: "Code system URI" },
      { name: "substance_code_display", type: "string(255)", constraints: [], desc: "Code display text" },
      { name: "category", type: "string(30)", constraints: [], desc: "food, medication, environment, biologic" },
      { name: "allergy_type", type: "string(30)", constraints: [], desc: "allergy, intolerance" },
      { name: "criticality", type: "string(20)", constraints: [], desc: "low, high, unable-to-assess" },
      { name: "clinical_status", type: "string(30)", constraints: ["R", "I"], desc: "active, inactive, resolved" },
      { name: "verification_status", type: "string(30)", constraints: [], desc: "unconfirmed, presumed, confirmed, refuted, entered-in-error" },
      { name: "onset_date", type: "date", constraints: [], desc: "When allergy began" },
      { name: "recorded_date", type: "datetime", constraints: ["R"], desc: "When recorded in system" },
      { name: "recorder_id", type: "string(100)", constraints: [], desc: "Who recorded" },
      { name: "asserter_id", type: "string(100)", constraints: [], desc: "Who asserted" },
      { name: "last_occurrence", type: "date", constraints: [], desc: "Date of last reaction" },
      { name: "reaction_manifestation", type: "json", constraints: [], desc: "Array of manifestation codes/descriptions" },
      { name: "reaction_severity", type: "string(20)", constraints: [], desc: "mild, moderate, severe" },
      { name: "reaction_onset", type: "string(50)", constraints: [], desc: "Onset timing of reaction" },
      { name: "reaction_description", type: "string", constraints: [], desc: "Narrative description of reaction" },
      { name: "reaction_exposure_route", type: "string(100)", constraints: [], desc: "Route of exposure" },
      { name: "clinical_note", type: "string", constraints: [], desc: "Additional notes" },
      { name: "fhir_allergy_id", type: "string(100)", constraints: ["I"], desc: "FHIR AllergyIntolerance identifier" },
      { name: "source", type: "string(50)", constraints: [], desc: "Source system" },
      { name: "source_id", type: "string(100)", constraints: [], desc: "Source record ID" },
      { name: "created_at", type: "datetime", constraints: ["R"], desc: "Record creation timestamp" },
      { name: "updated_at", type: "datetime", constraints: ["R"], desc: "Last update timestamp" }
    ]
  },
  {
    id: "medication",
    name: "MEDICATION",
    description: "Medication orders, prescriptions, and administration records. Supports both INSTRUCTION (what should happen) and ACTION (what was done) patterns.",
    openehr: "INSTRUCTION.medication_order.v3",
    fhir: "MedicationRequest / MedicationStatement",
    fields: [
      { name: "medication_id", type: "uuid", constraints: ["PK", "R"], desc: "Unique identifier" },
      { name: "composition_id", type: "uuid", constraints: ["FK", "I"], desc: "Parent composition (optional)" },
      { name: "member_id", type: "uuid", constraints: ["FK", "R", "I"], desc: "Reference to CORE.MEMBER" },
      { name: "archetype_id", type: "string(255)", constraints: ["R"], desc: "openEHR archetype ID" },
      { name: "entry_type", type: "string(30)", constraints: ["R", "I"], desc: "INSTRUCTION (order) or ACTION (administration)" },
      { name: "medication_name", type: "string(500)", constraints: ["R"], desc: "Medication name (generic or brand)" },
      { name: "medication_code", type: "string(20)", constraints: ["I"], desc: "NDC or RxNorm code" },
      { name: "medication_code_system", type: "string(100)", constraints: [], desc: "Code system URI" },
      { name: "medication_code_display", type: "string(500)", constraints: [], desc: "Code display text" },
      { name: "status", type: "string(30)", constraints: ["R", "I"], desc: "active, completed, cancelled, stopped, on-hold, draft, entered-in-error" },
      { name: "intent", type: "string(30)", constraints: [], desc: "order, plan, proposal, instance-order" },
      { name: "category", type: "string(50)", constraints: [], desc: "inpatient, outpatient, community, discharge" },
      { name: "dosage_text", type: "string(500)", constraints: [], desc: "Free-text dosage instructions" },
      { name: "dose_quantity", type: "decimal(10,4)", constraints: [], desc: "Dose amount" },
      { name: "dose_unit", type: "string(50)", constraints: [], desc: "Dose unit (mg, ml, tablet, etc.)" },
      { name: "route", type: "string(100)", constraints: [], desc: "Administration route (oral, IV, topical, etc.)" },
      { name: "route_code", type: "string(20)", constraints: [], desc: "SNOMED route code" },
      { name: "frequency_text", type: "string(100)", constraints: [], desc: "Frequency description (BID, TID, PRN)" },
      { name: "frequency_period", type: "decimal(5,2)", constraints: [], desc: "Frequency period value" },
      { name: "frequency_period_unit", type: "string(20)", constraints: [], desc: "Frequency period unit (h, d, wk)" },
      { name: "as_needed", type: "boolean", constraints: [], desc: "PRN flag" },
      { name: "as_needed_reason", type: "string(255)", constraints: [], desc: "PRN reason" },
      { name: "start_date", type: "date", constraints: [], desc: "Medication start date" },
      { name: "end_date", type: "date", constraints: [], desc: "Medication end date" },
      { name: "authored_on", type: "datetime", constraints: ["R"], desc: "When prescribed/ordered" },
      { name: "prescriber_id", type: "string(100)", constraints: [], desc: "Prescriber NPI or identifier" },
      { name: "prescriber_name", type: "string(255)", constraints: [], desc: "Prescriber name" },
      { name: "dispense_quantity", type: "decimal(10,2)", constraints: [], desc: "Quantity to dispense" },
      { name: "dispense_unit", type: "string(50)", constraints: [], desc: "Dispense unit" },
      { name: "refills_allowed", type: "integer", constraints: [], desc: "Number of refills" },
      { name: "substitution_allowed", type: "boolean", constraints: [], desc: "Generic substitution allowed" },
      { name: "reason_code", type: "string(20)", constraints: [], desc: "Reason for medication (ICD-10)" },
      { name: "reason_text", type: "string(500)", constraints: [], desc: "Reason description" },
      { name: "clinical_note", type: "string", constraints: [], desc: "Additional notes" },
      { name: "fhir_medication_id", type: "string(100)", constraints: ["I"], desc: "FHIR MedicationRequest identifier" },
      { name: "rx_claim_id", type: "uuid", constraints: ["FK", "I"], desc: "Link to CLAIMS.RX_CLAIM" },
      { name: "source", type: "string(50)", constraints: [], desc: "Source system" },
      { name: "source_id", type: "string(100)", constraints: [], desc: "Source record ID" },
      { name: "created_at", type: "datetime", constraints: ["R"], desc: "Record creation timestamp" },
      { name: "updated_at", type: "datetime", constraints: ["R"], desc: "Last update timestamp" }
    ]
  },
  {
    id: "vital_sign",
    name: "VITAL_SIGN",
    description: "Vital sign observations including blood pressure, pulse, temperature, respiratory rate, oxygen saturation, height, weight, and BMI.",
    openehr: "OBSERVATION.* (vitals)",
    fhir: "Observation (vital-signs)",
    fields: [
      { name: "vital_sign_id", type: "uuid", constraints: ["PK", "R"], desc: "Unique identifier" },
      { name: "composition_id", type: "uuid", constraints: ["FK", "I"], desc: "Parent composition (optional)" },
      { name: "member_id", type: "uuid", constraints: ["FK", "R", "I"], desc: "Reference to CORE.MEMBER" },
      { name: "archetype_id", type: "string(255)", constraints: ["R"], desc: "openEHR archetype ID" },
      { name: "vital_type", type: "string(50)", constraints: ["R", "I"], desc: "BLOOD_PRESSURE, PULSE, TEMPERATURE, RESPIRATORY_RATE, OXYGEN_SATURATION, HEIGHT, WEIGHT, BMI" },
      { name: "vital_code", type: "string(20)", constraints: [], desc: "LOINC code" },
      { name: "vital_code_system", type: "string(100)", constraints: [], desc: "Code system (http://loinc.org)" },
      { name: "vital_code_display", type: "string(255)", constraints: [], desc: "Code display text" },
      { name: "status", type: "string(30)", constraints: ["R"], desc: "registered, preliminary, final, amended, corrected, cancelled, entered-in-error" },
      { name: "effective_datetime", type: "datetime", constraints: ["R"], desc: "When measured" },
      { name: "value_quantity", type: "decimal(10,4)", constraints: [], desc: "Primary numeric value" },
      { name: "value_unit", type: "string(30)", constraints: [], desc: "Unit of measure" },
      { name: "value_systolic", type: "decimal(5,1)", constraints: [], desc: "Systolic BP (mmHg)" },
      { name: "value_diastolic", type: "decimal(5,1)", constraints: [], desc: "Diastolic BP (mmHg)" },
      { name: "value_text", type: "string(255)", constraints: [], desc: "Text value if non-numeric" },
      { name: "interpretation", type: "string(50)", constraints: [], desc: "N (normal), H (high), L (low), HH, LL, etc." },
      { name: "body_site", type: "string(100)", constraints: [], desc: "Body site of measurement" },
      { name: "body_site_code", type: "string(20)", constraints: [], desc: "SNOMED body site code" },
      { name: "method", type: "string(100)", constraints: [], desc: "Method of measurement" },
      { name: "device", type: "string(255)", constraints: [], desc: "Device used" },
      { name: "performer_id", type: "string(100)", constraints: [], desc: "Who performed measurement" },
      { name: "performer_name", type: "string(255)", constraints: [], desc: "Performer name" },
      { name: "encounter_id", type: "uuid", constraints: ["FK", "I"], desc: "Related encounter" },
      { name: "clinical_note", type: "string", constraints: [], desc: "Additional notes" },
      { name: "fhir_observation_id", type: "string(100)", constraints: ["I"], desc: "FHIR Observation identifier" },
      { name: "source", type: "string(50)", constraints: [], desc: "Source system" },
      { name: "source_id", type: "string(100)", constraints: [], desc: "Source record ID" },
      { name: "created_at", type: "datetime", constraints: ["R"], desc: "Record creation timestamp" },
      { name: "updated_at", type: "datetime", constraints: ["R"], desc: "Last update timestamp" }
    ]
  },
  {
    id: "lab_result",
    name: "LAB_RESULT",
    description: "Laboratory test results and diagnostic observations.",
    openehr: "OBSERVATION.laboratory_test_result.v1",
    fhir: "Observation (laboratory) / DiagnosticReport",
    fields: [
      { name: "lab_result_id", type: "uuid", constraints: ["PK", "R"], desc: "Unique identifier" },
      { name: "composition_id", type: "uuid", constraints: ["FK", "I"], desc: "Parent composition (optional)" },
      { name: "member_id", type: "uuid", constraints: ["FK", "R", "I"], desc: "Reference to CORE.MEMBER" },
      { name: "diagnostic_report_id", type: "uuid", constraints: ["FK", "I"], desc: "Parent DiagnosticReport (for panel results)" },
      { name: "archetype_id", type: "string(255)", constraints: ["R"], desc: "openEHR archetype ID" },
      { name: "test_name", type: "string(500)", constraints: ["R"], desc: "Test name" },
      { name: "test_code", type: "string(20)", constraints: ["I"], desc: "LOINC code" },
      { name: "test_code_system", type: "string(100)", constraints: [], desc: "Code system URI" },
      { name: "test_code_display", type: "string(500)", constraints: [], desc: "Code display text" },
      { name: "category", type: "string(50)", constraints: [], desc: "Laboratory category (chemistry, hematology, microbiology, etc.)" },
      { name: "status", type: "string(30)", constraints: ["R", "I"], desc: "registered, preliminary, final, amended, corrected, cancelled, entered-in-error" },
      { name: "effective_datetime", type: "datetime", constraints: ["R"], desc: "Specimen collection time" },
      { name: "issued", type: "datetime", constraints: [], desc: "Result issue time" },
      { name: "value_quantity", type: "decimal(15,6)", constraints: [], desc: "Numeric result value" },
      { name: "value_unit", type: "string(50)", constraints: [], desc: "Result unit" },
      { name: "value_string", type: "string(1000)", constraints: [], desc: "String result" },
      { name: "value_codeable_concept", type: "string(100)", constraints: [], desc: "Coded result" },
      { name: "value_codeable_system", type: "string(100)", constraints: [], desc: "Coded result system" },
      { name: "reference_range_low", type: "decimal(15,6)", constraints: [], desc: "Low normal value" },
      { name: "reference_range_high", type: "decimal(15,6)", constraints: [], desc: "High normal value" },
      { name: "reference_range_text", type: "string(255)", constraints: [], desc: "Reference range as text" },
      { name: "interpretation", type: "string(50)", constraints: [], desc: "N, H, L, HH, LL, A (abnormal), AA, etc." },
      { name: "specimen_type", type: "string(100)", constraints: [], desc: "Specimen type (blood, urine, etc.)" },
      { name: "specimen_code", type: "string(20)", constraints: [], desc: "SNOMED specimen code" },
      { name: "performing_lab", type: "string(255)", constraints: [], desc: "Performing laboratory name" },
      { name: "performing_lab_id", type: "string(100)", constraints: [], desc: "Lab identifier (CLIA, etc.)" },
      { name: "ordering_provider_id", type: "string(100)", constraints: [], desc: "Ordering provider NPI" },
      { name: "encounter_id", type: "uuid", constraints: ["FK", "I"], desc: "Related encounter" },
      { name: "clinical_note", type: "string", constraints: [], desc: "Comments/notes" },
      { name: "fhir_observation_id", type: "string(100)", constraints: ["I"], desc: "FHIR Observation identifier" },
      { name: "medical_claim_id", type: "uuid", constraints: ["FK", "I"], desc: "Link to CLAIMS.MEDICAL_CLAIM" },
      { name: "source", type: "string(50)", constraints: [], desc: "Source system" },
      { name: "source_id", type: "string(100)", constraints: [], desc: "Source record ID" },
      { name: "created_at", type: "datetime", constraints: ["R"], desc: "Record creation timestamp" },
      { name: "updated_at", type: "datetime", constraints: ["R"], desc: "Last update timestamp" }
    ]
  },
  {
    id: "procedure_record",
    name: "PROCEDURE_RECORD",
    description: "Clinical procedures performed on the patient.",
    openehr: "ACTION.procedure.v1",
    fhir: "Procedure",
    fields: [
      { name: "procedure_record_id", type: "uuid", constraints: ["PK", "R"], desc: "Unique identifier" },
      { name: "composition_id", type: "uuid", constraints: ["FK", "I"], desc: "Parent composition (optional)" },
      { name: "member_id", type: "uuid", constraints: ["FK", "R", "I"], desc: "Reference to CORE.MEMBER" },
      { name: "archetype_id", type: "string(255)", constraints: ["R"], desc: "openEHR archetype ID" },
      { name: "procedure_name", type: "string(500)", constraints: ["R"], desc: "Procedure name" },
      { name: "procedure_code", type: "string(20)", constraints: ["I"], desc: "CPT, SNOMED, or ICD-10-PCS code" },
      { name: "procedure_code_system", type: "string(100)", constraints: [], desc: "Code system URI" },
      { name: "procedure_code_display", type: "string(500)", constraints: [], desc: "Code display text" },
      { name: "status", type: "string(30)", constraints: ["R", "I"], desc: "preparation, in-progress, not-done, on-hold, stopped, completed, entered-in-error, unknown" },
      { name: "status_reason", type: "string(255)", constraints: [], desc: "Reason for status (especially if not-done)" },
      { name: "category", type: "string(50)", constraints: [], desc: "Procedure category" },
      { name: "performed_datetime", type: "datetime", constraints: [], desc: "When performed (point in time)" },
      { name: "performed_period_start", type: "datetime", constraints: [], desc: "Start of procedure" },
      { name: "performed_period_end", type: "datetime", constraints: [], desc: "End of procedure" },
      { name: "body_site", type: "string(255)", constraints: [], desc: "Body site" },
      { name: "body_site_code", type: "string(20)", constraints: [], desc: "SNOMED body site code" },
      { name: "laterality", type: "string(20)", constraints: [], desc: "left, right, bilateral" },
      { name: "performer_id", type: "string(100)", constraints: [], desc: "Primary performer NPI" },
      { name: "performer_name", type: "string(255)", constraints: [], desc: "Performer name" },
      { name: "performer_role", type: "string(100)", constraints: [], desc: "Performer role (surgeon, assistant, etc.)" },
      { name: "location_id", type: "string(100)", constraints: [], desc: "Where performed" },
      { name: "location_name", type: "string(255)", constraints: [], desc: "Location name" },
      { name: "encounter_id", type: "uuid", constraints: ["FK", "I"], desc: "Related encounter" },
      { name: "reason_code", type: "string(20)", constraints: [], desc: "Reason code (ICD-10)" },
      { name: "reason_text", type: "string(500)", constraints: [], desc: "Reason description" },
      { name: "outcome", type: "string(255)", constraints: [], desc: "Procedure outcome" },
      { name: "complication", type: "string(500)", constraints: [], desc: "Complications" },
      { name: "clinical_note", type: "string", constraints: [], desc: "Additional notes" },
      { name: "fhir_procedure_id", type: "string(100)", constraints: ["I"], desc: "FHIR Procedure identifier" },
      { name: "medical_claim_id", type: "uuid", constraints: ["FK", "I"], desc: "Link to CLAIMS.MEDICAL_CLAIM" },
      { name: "source", type: "string(50)", constraints: [], desc: "Source system" },
      { name: "source_id", type: "string(100)", constraints: [], desc: "Source record ID" },
      { name: "created_at", type: "datetime", constraints: ["R"], desc: "Record creation timestamp" },
      { name: "updated_at", type: "datetime", constraints: ["R"], desc: "Last update timestamp" }
    ]
  },
  {
    id: "immunization",
    name: "IMMUNIZATION",
    description: "Vaccination and immunization records.",
    openehr: "ACTION.immunisation.v1",
    fhir: "Immunization",
    fields: [
      { name: "immunization_id", type: "uuid", constraints: ["PK", "R"], desc: "Unique identifier" },
      { name: "composition_id", type: "uuid", constraints: ["FK", "I"], desc: "Parent composition (optional)" },
      { name: "member_id", type: "uuid", constraints: ["FK", "R", "I"], desc: "Reference to CORE.MEMBER" },
      { name: "archetype_id", type: "string(255)", constraints: ["R"], desc: "openEHR archetype ID" },
      { name: "vaccine_name", type: "string(500)", constraints: ["R"], desc: "Vaccine product name" },
      { name: "vaccine_code", type: "string(20)", constraints: ["I"], desc: "CVX code" },
      { name: "vaccine_code_system", type: "string(100)", constraints: [], desc: "Code system (http://hl7.org/fhir/sid/cvx)" },
      { name: "vaccine_code_display", type: "string(500)", constraints: [], desc: "Code display text" },
      { name: "status", type: "string(30)", constraints: ["R", "I"], desc: "completed, entered-in-error, not-done" },
      { name: "status_reason", type: "string(255)", constraints: [], desc: "Reason if not-done" },
      { name: "occurrence_datetime", type: "datetime", constraints: ["R"], desc: "When administered" },
      { name: "recorded_date", type: "datetime", constraints: [], desc: "When recorded in system" },
      { name: "primary_source", type: "boolean", constraints: [], desc: "True if from administering provider" },
      { name: "report_origin", type: "string(100)", constraints: [], desc: "Source of reported immunization" },
      { name: "lot_number", type: "string(50)", constraints: [], desc: "Vaccine lot number" },
      { name: "expiration_date", type: "date", constraints: [], desc: "Vaccine expiration date" },
      { name: "site", type: "string(100)", constraints: [], desc: "Body site of administration" },
      { name: "site_code", type: "string(20)", constraints: [], desc: "SNOMED site code" },
      { name: "route", type: "string(100)", constraints: [], desc: "Administration route" },
      { name: "route_code", type: "string(20)", constraints: [], desc: "SNOMED route code" },
      { name: "dose_quantity", type: "decimal(10,4)", constraints: [], desc: "Dose amount" },
      { name: "dose_unit", type: "string(50)", constraints: [], desc: "Dose unit" },
      { name: "performer_id", type: "string(100)", constraints: [], desc: "Administering provider" },
      { name: "performer_name", type: "string(255)", constraints: [], desc: "Provider name" },
      { name: "location_id", type: "string(100)", constraints: [], desc: "Administration location" },
      { name: "encounter_id", type: "uuid", constraints: ["FK", "I"], desc: "Related encounter" },
      { name: "clinical_note", type: "string", constraints: [], desc: "Additional notes" },
      { name: "fhir_immunization_id", type: "string(100)", constraints: ["I"], desc: "FHIR Immunization identifier" },
      { name: "source", type: "string(50)", constraints: [], desc: "Source system" },
      { name: "source_id", type: "string(100)", constraints: [], desc: "Source record ID" },
      { name: "created_at", type: "datetime", constraints: ["R"], desc: "Record creation timestamp" },
      { name: "updated_at", type: "datetime", constraints: ["R"], desc: "Last update timestamp" }
    ]
  },
  {
    id: "clinical_note",
    name: "CLINICAL_NOTE",
    description: "Clinical narratives, summaries, and documentation.",
    openehr: "COMPOSITION.report.v1",
    fhir: "DocumentReference",
    fields: [
      { name: "clinical_note_id", type: "uuid", constraints: ["PK", "R"], desc: "Unique identifier" },
      { name: "composition_id", type: "uuid", constraints: ["FK", "I"], desc: "Parent composition (optional)" },
      { name: "member_id", type: "uuid", constraints: ["FK", "R", "I"], desc: "Reference to CORE.MEMBER" },
      { name: "archetype_id", type: "string(255)", constraints: ["R"], desc: "openEHR archetype ID" },
      { name: "document_type", type: "string(50)", constraints: ["R", "I"], desc: "progress_note, discharge_summary, consultation, history_physical, procedure_note, etc." },
      { name: "document_type_code", type: "string(20)", constraints: [], desc: "LOINC document type code" },
      { name: "document_status", type: "string(30)", constraints: ["R"], desc: "current, superseded, entered-in-error" },
      { name: "doc_status", type: "string(30)", constraints: [], desc: "preliminary, final, amended, corrected" },
      { name: "title", type: "string(500)", constraints: [], desc: "Document title" },
      { name: "content_text", type: "string", constraints: [], desc: "Plain text content" },
      { name: "content_format", type: "string(50)", constraints: [], desc: "text/plain, text/html, application/pdf" },
      { name: "content_url", type: "string(1000)", constraints: [], desc: "URL to document content" },
      { name: "content_size", type: "integer", constraints: [], desc: "Content size in bytes" },
      { name: "content_hash", type: "string(64)", constraints: [], desc: "SHA-256 hash of content" },
      { name: "created_datetime", type: "datetime", constraints: ["R"], desc: "When document was created" },
      { name: "author_id", type: "string(100)", constraints: [], desc: "Author identifier" },
      { name: "author_name", type: "string(255)", constraints: [], desc: "Author name" },
      { name: "authenticator_id", type: "string(100)", constraints: [], desc: "Authenticator/signer" },
      { name: "custodian_id", type: "string(100)", constraints: [], desc: "Custodian organization" },
      { name: "encounter_id", type: "uuid", constraints: ["FK", "I"], desc: "Related encounter" },
      { name: "clinical_context", type: "string(255)", constraints: [], desc: "Clinical context" },
      { name: "fhir_document_id", type: "string(100)", constraints: ["I"], desc: "FHIR DocumentReference identifier" },
      { name: "source", type: "string(50)", constraints: [], desc: "Source system" },
      { name: "source_id", type: "string(100)", constraints: [], desc: "Source record ID" },
      { name: "created_at", type: "datetime", constraints: ["R"], desc: "Record creation timestamp" },
      { name: "updated_at", type: "datetime", constraints: ["R"], desc: "Last update timestamp" }
    ]
  },
  {
    id: "care_plan",
    name: "CARE_PLAN",
    description: "Care plans, treatment plans, and goals.",
    openehr: "INSTRUCTION.care_plan.v1",
    fhir: "CarePlan",
    fields: [
      { name: "care_plan_id", type: "uuid", constraints: ["PK", "R"], desc: "Unique identifier" },
      { name: "composition_id", type: "uuid", constraints: ["FK", "I"], desc: "Parent composition (optional)" },
      { name: "member_id", type: "uuid", constraints: ["FK", "R", "I"], desc: "Reference to CORE.MEMBER" },
      { name: "archetype_id", type: "string(255)", constraints: ["R"], desc: "openEHR archetype ID" },
      { name: "plan_title", type: "string(500)", constraints: ["R"], desc: "Care plan title" },
      { name: "plan_description", type: "string", constraints: [], desc: "Plan description" },
      { name: "status", type: "string(30)", constraints: ["R", "I"], desc: "draft, active, on-hold, revoked, completed, entered-in-error, unknown" },
      { name: "intent", type: "string(30)", constraints: ["R"], desc: "proposal, plan, order, option" },
      { name: "category", type: "string(50)", constraints: [], desc: "assess-plan, discharge, longitudinal, etc." },
      { name: "period_start", type: "date", constraints: [], desc: "Plan start date" },
      { name: "period_end", type: "date", constraints: [], desc: "Plan end date" },
      { name: "created_datetime", type: "datetime", constraints: ["R"], desc: "When plan was created" },
      { name: "author_id", type: "string(100)", constraints: [], desc: "Author identifier" },
      { name: "author_name", type: "string(255)", constraints: [], desc: "Author name" },
      { name: "contributor_ids", type: "json", constraints: [], desc: "Array of contributor identifiers" },
      { name: "addresses_conditions", type: "json", constraints: [], desc: "Array of condition IDs this plan addresses" },
      { name: "goals", type: "json", constraints: [], desc: "Array of goal descriptions" },
      { name: "activities", type: "json", constraints: [], desc: "Array of planned activities" },
      { name: "encounter_id", type: "uuid", constraints: ["FK", "I"], desc: "Related encounter" },
      { name: "clinical_note", type: "string", constraints: [], desc: "Additional notes" },
      { name: "fhir_careplan_id", type: "string(100)", constraints: ["I"], desc: "FHIR CarePlan identifier" },
      { name: "source", type: "string(50)", constraints: [], desc: "Source system" },
      { name: "source_id", type: "string(100)", constraints: [], desc: "Source record ID" },
      { name: "created_at", type: "datetime", constraints: ["R"], desc: "Record creation timestamp" },
      { name: "updated_at", type: "datetime", constraints: ["R"], desc: "Last update timestamp" }
    ]
  },
  {
    id: "encounter_record",
    name: "ENCOUNTER_RECORD",
    description: "Clinical encounters, visits, and admissions.",
    openehr: "COMPOSITION.encounter.v1",
    fhir: "Encounter",
    fields: [
      { name: "encounter_id", type: "uuid", constraints: ["PK", "R"], desc: "Unique identifier" },
      { name: "composition_id", type: "uuid", constraints: ["FK", "I"], desc: "Parent composition (if exists)" },
      { name: "member_id", type: "uuid", constraints: ["FK", "R", "I"], desc: "Reference to CORE.MEMBER" },
      { name: "archetype_id", type: "string(255)", constraints: ["R"], desc: "openEHR archetype ID" },
      { name: "encounter_class", type: "string(30)", constraints: ["R", "I"], desc: "ambulatory, emergency, field, home, inpatient, short-stay, virtual" },
      { name: "encounter_class_code", type: "string(20)", constraints: [], desc: "ActCode system code" },
      { name: "encounter_type", type: "string(100)", constraints: [], desc: "Specific encounter type" },
      { name: "encounter_type_code", type: "string(20)", constraints: [], desc: "SNOMED encounter type code" },
      { name: "status", type: "string(30)", constraints: ["R"], desc: "planned, arrived, triaged, in-progress, onleave, finished, cancelled, entered-in-error, unknown" },
      { name: "priority", type: "string(30)", constraints: [], desc: "Urgency level" },
      { name: "period_start", type: "datetime", constraints: ["R"], desc: "Encounter start time" },
      { name: "period_end", type: "datetime", constraints: [], desc: "Encounter end time" },
      { name: "length_minutes", type: "integer", constraints: [], desc: "Duration in minutes" },
      { name: "reason_code", type: "string(20)", constraints: [], desc: "Reason for visit (ICD-10)" },
      { name: "reason_text", type: "string(500)", constraints: [], desc: "Reason description" },
      { name: "admission_source", type: "string(100)", constraints: [], desc: "Where patient came from" },
      { name: "discharge_disposition", type: "string(100)", constraints: [], desc: "Discharge disposition" },
      { name: "participant_ids", type: "json", constraints: [], desc: "Array of participant identifiers" },
      { name: "location_id", type: "string(100)", constraints: [], desc: "Facility/location ID" },
      { name: "location_name", type: "string(255)", constraints: [], desc: "Location name" },
      { name: "service_provider_id", type: "string(100)", constraints: [], desc: "Service provider organization" },
      { name: "diagnosis_ids", type: "json", constraints: [], desc: "Array of diagnosis/problem IDs" },
      { name: "hospitalization_admit_source", type: "string(100)", constraints: [], desc: "Admit source for inpatient" },
      { name: "hospitalization_discharge_disposition", type: "string(100)", constraints: [], desc: "Discharge status" },
      { name: "clinical_admission_id", type: "uuid", constraints: ["FK", "I"], desc: "Link to CLINICAL.ADMISSION" },
      { name: "fhir_encounter_id", type: "string(100)", constraints: ["I"], desc: "FHIR Encounter identifier" },
      { name: "source", type: "string(50)", constraints: [], desc: "Source system" },
      { name: "source_id", type: "string(100)", constraints: [], desc: "Source record ID" },
      { name: "created_at", type: "datetime", constraints: ["R"], desc: "Record creation timestamp" },
      { name: "updated_at", type: "datetime", constraints: ["R"], desc: "Last update timestamp" }
    ]
  },
  {
    id: "health_record_provenance",
    name: "HEALTH_RECORD_PROVENANCE",
    description: "Audit trail and data lineage tracking for all health record changes.",
    openehr: "RM.AUDIT_DETAILS",
    fhir: "Provenance",
    fields: [
      { name: "provenance_id", type: "uuid", constraints: ["PK", "R"], desc: "Unique identifier" },
      { name: "target_type", type: "string(50)", constraints: ["R", "I"], desc: "Target entity type (PROBLEM, ALLERGY, MEDICATION, etc.)" },
      { name: "target_id", type: "uuid", constraints: ["R", "I"], desc: "Target entity ID" },
      { name: "recorded", type: "datetime", constraints: ["R"], desc: "When provenance was recorded" },
      { name: "occurred_datetime", type: "datetime", constraints: [], desc: "When the activity occurred" },
      { name: "activity", type: "string(50)", constraints: ["R"], desc: "Activity type: CREATE, UPDATE, DELETE, VERIFY, SIGN" },
      { name: "activity_code", type: "string(20)", constraints: [], desc: "Provenance activity code" },
      { name: "reason", type: "string(500)", constraints: [], desc: "Reason for activity" },
      { name: "agent_type", type: "string(50)", constraints: ["R"], desc: "author, informant, verifier, enterer, performer, custodian" },
      { name: "agent_id", type: "string(100)", constraints: ["R"], desc: "Agent identifier (user ID, system ID)" },
      { name: "agent_name", type: "string(255)", constraints: [], desc: "Agent name" },
      { name: "agent_role", type: "string(100)", constraints: [], desc: "Agent role" },
      { name: "on_behalf_of_id", type: "string(100)", constraints: [], desc: "Acting on behalf of (organization)" },
      { name: "location_id", type: "string(100)", constraints: [], desc: "Location of activity" },
      { name: "signature", type: "string", constraints: [], desc: "Digital signature (if signed)" },
      { name: "signature_type", type: "string(50)", constraints: [], desc: "Signature type" },
      { name: "policy", type: "string(500)", constraints: [], desc: "Policy/consent reference" },
      { name: "fhir_provenance_id", type: "string(100)", constraints: ["I"], desc: "FHIR Provenance identifier" },
      { name: "created_at", type: "datetime", constraints: ["R"], desc: "Record creation timestamp" }
    ]
  }
];

// ---- RENDERING ----

let currentView = 'table';

function buildSidebar() {
  const nav = document.getElementById('sidebar-nav');
  nav.innerHTML = ENTITIES.map((e, i) => {
    const shortName = e.name.replace('HEALTH_RECORD_', '').replace('_RECORD', '');
    return `<a href="#${e.id}" data-id="${e.id}">
      <span class="num">${i + 1}</span>
      <span>${shortName}</span>
      <span class="field-count">${e.fields.length}</span>
    </a>`;
  }).join('');
}

function constraintHtml(c) {
  const cls = { PK: 'c-pk', FK: 'c-fk', R: 'c-r', I: 'c-i', U: 'c-u' };
  return `<span class="constraint ${cls[c] || ''}">${c}</span>`;
}

function renderTableView(entity) {
  return `<div class="table-view">
    <table>
      <thead><tr><th>Field</th><th>Type</th><th>Constraints</th><th>Description</th></tr></thead>
      <tbody>${entity.fields.map(f => `<tr>
        <td class="field-name">${f.name}</td>
        <td class="field-type">${f.type}</td>
        <td>${f.constraints.map(constraintHtml).join(' ')}</td>
        <td>${f.desc}</td>
      </tr>`).join('')}</tbody>
    </table>
  </div>`;
}

function typeToJsonType(t) {
  if (t.startsWith('uuid')) return '"binData"';
  if (t.startsWith('string')) return '"string"';
  if (t.startsWith('integer') || t === 'int') return '"int"';
  if (t.startsWith('decimal')) return '"decimal"';
  if (t.startsWith('date') || t === 'datetime' || t === 'timestamp') return '"date"';
  if (t === 'boolean') return '"bool"';
  if (t === 'json') return '"array"';
  return `"${t}"`;
}

function renderJsonView(entity) {
  const required = entity.fields.filter(f => f.constraints.includes('R')).map(f => `"${f.name}"`);
  const props = entity.fields.map(f => {
    const jt = typeToJsonType(f.type);
    return `      <span class="jk">"${f.name}"</span>: {
        <span class="jk">"bsonType"</span>: <span class="js">${jt}</span>,
        <span class="jk">"description"</span>: <span class="js">"${f.desc.replace(/"/g, '\\"')}"</span>
      }`;
  }).join(',\n');

  const json = `{
  <span class="jk">"bsonType"</span>: <span class="js">"object"</span>,
  <span class="jk">"title"</span>: <span class="js">"${entity.name}"</span>,
  <span class="jk">"description"</span>: <span class="js">"${entity.description.replace(/"/g, '\\"')}"</span>,
  <span class="jc">// openEHR: ${entity.openehr}</span>
  <span class="jc">// FHIR:    ${entity.fhir}</span>
  <span class="jk">"required"</span>: [${required.join(', ')}],
  <span class="jk">"properties"</span>: {
${props}
  }
}`;
  return `<div class="json-view"><pre>${json}</pre></div>`;
}

function renderEntities() {
  const content = document.getElementById('content');
  content.innerHTML = ENTITIES.map(e => `
    <div class="entity-section" id="${e.id}" data-name="${e.name}">
      <div class="entity-header">
        <h2>${e.name}</h2>
        <div class="entity-meta">
          <span class="tag tag-openehr">${e.openehr}</span>
          <span class="tag tag-fhir">${e.fhir}</span>
          <span class="tag tag-fields">${e.fields.length} fields</span>
        </div>
      </div>
      <div class="entity-desc">${e.description}</div>
      <div class="entity-body">
        ${renderTableView(e)}
        ${renderJsonView(e)}
      </div>
    </div>
  `).join('');
  applyView();
}

function setView(view) {
  currentView = view;
  document.querySelectorAll('.view-toggle button').forEach(b => b.classList.remove('active'));
  document.querySelector(`.view-toggle button[onclick="setView('${view}')"]`).classList.add('active');
  applyView();
}

function applyView() {
  document.querySelectorAll('.table-view').forEach(el => el.style.display = currentView === 'table' ? '' : 'none');
  document.querySelectorAll('.json-view').forEach(el => el.style.display = currentView === 'json' ? '' : 'none');
}

function filterEntities(query) {
  const q = query.toLowerCase().trim();
  const sections = document.querySelectorAll('.entity-section');
  let anyVisible = false;

  sections.forEach(section => {
    if (!q) {
      section.classList.remove('hidden');
      anyVisible = true;
      section.querySelectorAll('.match-highlight').forEach(el => {
        el.outerHTML = el.textContent;
      });
      return;
    }
    const name = section.dataset.name.toLowerCase();
    const allText = section.textContent.toLowerCase();
    const match = allText.includes(q) || name.includes(q);
    section.classList.toggle('hidden', !match);
    if (match) anyVisible = true;
  });

  document.getElementById('noResults').classList.toggle('hidden', anyVisible);
}

// Sidebar active state on scroll
function updateActiveSidebar() {
  const sections = document.querySelectorAll('.entity-section');
  const links = document.querySelectorAll('#sidebar-nav a');
  let current = '';
  sections.forEach(s => {
    const rect = s.getBoundingClientRect();
    if (rect.top <= 150) current = s.id;
  });
  links.forEach(a => a.classList.toggle('active', a.dataset.id === current));
}

window.addEventListener('scroll', updateActiveSidebar);

// Initialize
buildSidebar();
renderEntities();
</script>

</body>
</html>
